<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Smart Traffic Junction Demo</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; background:#0b0f1a; color:#e8eefc; }
    .top { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    button, select, input { background:#1b2750; border:1px solid #2b3a68; color:#e8eefc; padding:8px 10px; border-radius:10px; cursor:pointer; }
    button:hover { background:#25346a; }
    .card { background:#121a2e; border:1px solid #223055; border-radius:14px; padding:12px; box-shadow:0 6px 20px rgba(0,0,0,0.25); }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .small { font-size:12px; color:#b6c4ee; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #2b3a68; }
    .pill.green { background: rgba(45, 200, 90, 0.15); border-color: rgba(45, 200, 90, 0.35); }
    .pill.red { background: rgba(220, 70, 70, 0.15); border-color: rgba(220, 70, 70, 0.35); }

    /* Junction SVG styling */
    .vizWrap { width: 720px; max-width:100%; }
    svg { width:100%; height:auto; display:block; }
    .road { fill:#0e152c; stroke:#2b3a68; stroke-width:2; }
    .laneMark { stroke:#2b3a68; stroke-width:2; stroke-dasharray:8 8; opacity:0.8; }
    .stopLine { stroke:#e8eefc; stroke-width:3; opacity:0.35; }
    .sig { fill:#a6b7e8; }
    .sig.green { fill:#2dd05a; }
    .sig.red { fill:#dc4646; }

    .car { rx:4; ry:4; }
    .car.in { fill:#6aa5ff; }
    .car.out { fill:#9fb7ff; opacity:0.6; }
    .car.emergency { fill:#ffd166; }
    .hud { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; flex-wrap:wrap; gap:10px; }
    .stats { display:grid; grid-template-columns: repeat(4, minmax(120px,1fr)); gap:8px; width:100%; margin-top:10px; }
    .stat { background: rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.06); padding:10px; border-radius:12px; }
    .stat b { display:block; font-size:14px; }
  </style>
</head>

<body>
  <h2 style="margin:0 0 10px 0;">Single Smart Junction Traffic Optimizer</h2>

  <div class="top card">
    <button id="btnStart">Start</button>
    <button id="btnPause">Pause</button>
    <button id="btnReset">Reset</button>

    <span class="small">Mode:</span>
    <select id="mode">
      <option value="dynamic">Dynamic (Optimized)</option>
      <option value="fixed">Fixed (Baseline)</option>
    </select>

    <span class="small">Scenario:</span>
    <select id="scenario">
      <option value="normal">Normal</option>
      <option value="morning_peak">Morning Peak</option>
      <option value="evening_peak">Evening Peak</option>
      <option value="accident_eastbound">Accident (Eastbound)</option>
    </select>

    <label class="small"><input type="checkbox" id="autoEvents" checked/> Auto Events</label>

    <span class="small">Inject at:</span>
    <select id="injWhere">
      <option value="N">North</option>
      <option value="S">South</option>
      <option value="E">East</option>
      <option value="W">West</option>
    </select>

    <button id="btnEmergency">Emergency</button>
    <button id="btnPedNS">Pedestrian (NS)</button>
    <button id="btnPedEW">Pedestrian (EW)</button>

    <span id="status" class="small">Connectingâ€¦</span>
  </div>

  <div class="row">
    <div class="card vizWrap">
      <div class="hud">
        <div>
          <div><b>Intersection A (Single Junction View)</b></div>
          <div class="small" id="phaseLine">Phase: -</div>
        </div>
        <div>
          <span id="badge" class="pill green">dynamic</span>
        </div>
      </div>

      <!-- Single cross junction -->
      <svg id="junction" viewBox="0 0 800 520" aria-label="junction">
        <!-- Roads (horizontal + vertical) -->
        <rect class="road" x="0" y="200" width="800" height="120"/>
        <rect class="road" x="340" y="0" width="120" height="520"/>

        <!-- Lane markings (2 lanes per direction: center divider + lane dividers) -->
        <!-- Vertical road markings -->
        <line class="laneMark" x1="400" y1="0" x2="400" y2="520"/>
        <line class="laneMark" x1="370" y1="0" x2="370" y2="520"/>
        <line class="laneMark" x1="430" y1="0" x2="430" y2="520"/>

        <!-- Horizontal road markings -->
        <line class="laneMark" x1="0" y1="260" x2="800" y2="260"/>
        <line class="laneMark" x1="0" y1="230" x2="800" y2="230"/>
        <line class="laneMark" x1="0" y1="290" x2="800" y2="290"/>

        <!-- Stop lines (just before junction box) -->
        <line class="stopLine" x1="340" y1="195" x2="460" y2="195"/> <!-- North stop -->
        <line class="stopLine" x1="340" y1="325" x2="460" y2="325"/> <!-- South stop -->
        <line class="stopLine" x1="335" y1="200" x2="335" y2="320"/> <!-- West stop -->
        <line class="stopLine" x1="465" y1="200" x2="465" y2="320"/> <!-- East stop -->

        <!-- Signal lights (NS pair + EW pair) -->
        <circle id="sigNS" class="sig" cx="490" cy="175" r="10"></circle>
        <circle id="sigEW" class="sig" cx="490" cy="345" r="10"></circle>

        <!-- Cars group (we will draw cars here) -->
        <g id="cars"></g>

        <!-- Labels -->
        <text x="380" y="20" fill="#b6c4ee" font-size="14">N</text>
        <text x="380" y="510" fill="#b6c4ee" font-size="14">S</text>
        <text x="10" y="270" fill="#b6c4ee" font-size="14">W</text>
        <text x="780" y="270" fill="#b6c4ee" font-size="14">E</text>
      </svg>

      <div class="stats">
        <div class="stat"><b id="qN">N-IN: 0</b><span class="small">cars waiting</span></div>
        <div class="stat"><b id="qS">S-IN: 0</b><span class="small">cars waiting</span></div>
        <div class="stat"><b id="qE">E-IN: 0</b><span class="small">cars waiting</span></div>
        <div class="stat"><b id="qW">W-IN: 0</b><span class="small">cars waiting</span></div>
      </div>

      <div class="small" id="reasonLine" style="margin-top:10px;">Reason: -</div>
    </div>
  </div>

<script>
const API = "http://localhost:8000";
let timer = null;
let currentMode = "dynamic"; // "fixed" or "dynamic"

// draw cars from queue values (IN lanes only)
function drawCars(q, emergencyDir) {
  const carsG = document.getElementById("cars");
  carsG.innerHTML = "";

  const cap = (n) => Math.max(0, Math.min(10, n)); // max 10 cars per approach
  const N = cap(q.N), S = cap(q.S), E = cap(q.E), W = cap(q.W);

  // Geometry: IN lanes positions (two lanes per road: IN + OUT)
  // We'll draw IN lane cars near stop line, stacking backwards.
  const spacing = 22;

  // North IN lane (coming down): x=385 lane, y increases towards stop line at ~195
  for (let i=0; i<N; i++) {
    const x = 378, y = 40 + i*spacing;
    addCar(x, y, 18, 26, "N", emergencyDir==="N");
  }
  // South IN lane (coming up): x=408 lane, y decreases towards stop line at ~325
  for (let i=0; i<S; i++) {
    const x = 408, y = 470 - i*spacing;
    addCar(x, y, 18, 26, "S", emergencyDir==="S");
  }
  // East IN lane (coming left): y=278 lane, x decreases towards stop line at ~465
  for (let i=0; i<E; i++) {
    const x = 740 - i*spacing, y = 278;
    addCar(x, y, 26, 18, "E", emergencyDir==="E");
  }
  // West IN lane (coming right): y=248 lane, x increases towards stop line at ~335
  for (let i=0; i<W; i++) {
    const x = 40 + i*spacing, y = 248;
    addCar(x, y, 26, 18, "W", emergencyDir==="W");
  }

  function addCar(x,y,w,h,dir,isEmer) {
    const r = document.createElementNS("http://www.w3.org/2000/svg","rect");
    r.setAttribute("x", x);
    r.setAttribute("y", y);
    r.setAttribute("width", w);
    r.setAttribute("height", h);
    r.setAttribute("class", `car in${isEmer ? " emergency":""}`);
    r.setAttribute("data-dir", dir);
    carsG.appendChild(r);
  }
}

function setSignals(phase, inTransition) {
  const sigNS = document.getElementById("sigNS");
  const sigEW = document.getElementById("sigEW");
  sigNS.classList.remove("green","red");
  sigEW.classList.remove("green","red");

  // During transition -> all red
  if (inTransition) {
    sigNS.classList.add("red");
    sigEW.classList.add("red");
    return;
  }
  if (phase === "NS") {
    sigNS.classList.add("green");
    sigEW.classList.add("red");
  } else {
    sigNS.classList.add("red");
    sigEW.classList.add("green");
  }
}

async function api(method, path, body=null) {
  const opts = { method, headers: {"Content-Type":"application/json"} };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(`${API}${path}`, opts);
  return await res.json();
}

async function tickOnce() {
  const data = await api("POST","/tick");
  const sim = (currentMode === "fixed") ? data.fixed : data.dynamic;

  const A = sim.intersections.find(x => x.id === "A") || sim.intersections[0];
  const q = A.queues;

  document.getElementById("status").textContent =
    `t=${sim.t}s | scenario=${sim.scenario} | running=${data.running}`;

  document.getElementById("badge").textContent = currentMode;
  document.getElementById("badge").className = "pill " + (currentMode==="dynamic" ? "green":"red");

  document.getElementById("phaseLine").textContent =
    `Phase: ${A.phase} | time left: ${A.time_left}s ${A.in_transition ? "(transition)" : ""}`;

  document.getElementById("reasonLine").textContent = `Reason: ${A.reason || "-"}`;

  document.getElementById("qN").textContent = `N-IN: ${q.N}`;
  document.getElementById("qS").textContent = `S-IN: ${q.S}`;
  document.getElementById("qE").textContent = `E-IN: ${q.E}`;
  document.getElementById("qW").textContent = `W-IN: ${q.W}`;

  setSignals(A.phase, A.in_transition);

  // Show emergency highlight on the approach if active
  const emergencyDir = (A.emergency && Object.keys(A.emergency).find(k => A.emergency[k])) || null;
  drawCars(q, emergencyDir);
}

function startLoop() {
  if (timer) return;
  timer = setInterval(tickOnce, 800);
}
function stopLoop() {
  if (!timer) return;
  clearInterval(timer);
  timer = null;
}

document.getElementById("btnStart").onclick = async () => {
  await api("POST","/control",{running:true});
  startLoop();
};
document.getElementById("btnPause").onclick = async () => {
  await api("POST","/control",{running:false});
  stopLoop();
  await tickOnce();
};
document.getElementById("btnReset").onclick = async () => {
  await api("POST","/control",{seed: 42});
  await tickOnce();
};

document.getElementById("mode").onchange = async (e) => {
  currentMode = e.target.value;
  await tickOnce();
};

document.getElementById("scenario").onchange = async (e) => {
  await api("POST","/control",{scenario: e.target.value});
  await tickOnce();
};

document.getElementById("autoEvents").onchange = async (e) => {
  await api("POST","/control",{auto_events: e.target.checked});
};

document.getElementById("btnEmergency").onclick = async () => {
  const where = document.getElementById("injWhere").value;
  await api("POST","/inject",{intersection_id:"A", kind:"emergency", where});
  await tickOnce();
};
document.getElementById("btnPedNS").onclick = async () => {
  await api("POST","/inject",{intersection_id:"A", kind:"ped", where:"NS"});
  await tickOnce();
};
document.getElementById("btnPedEW").onclick = async () => {
  await api("POST","/inject",{intersection_id:"A", kind:"ped", where:"EW"});
  await tickOnce();
};

// initial paint
(async () => {
  try {
    await api("GET","/health");
    await tickOnce();
  } catch(e) {
    document.getElementById("status").textContent = "Backend not running on 8000.";
  }
})();
</script>
</body>
</html>
